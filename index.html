<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SymmetryFace - Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body{margin:0;background:#000;overflow:hidden;font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh}
        canvas{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:100%;max-height:100%;object-fit:contain;display:none}
        video{display:none}
        #landing{position:relative;z-index:200;text-align:center;color:#fff;padding:20px;max-width:400px}
        #app-logo{width:220px;height:220px;margin-bottom:20px;border-radius:50%;border:2px solid #0f0;box-shadow: 0 0 20px rgba(15, 255, 0, 0.4); background: #fff; object-fit: contain; padding: 10px;}
        #landing h1{font-size:38px;margin:0 0 10px 0;color:#0f0;text-shadow:0 0 10px rgba(0,255,0,0.5)}
        #startBtn{padding:18px 50px;font-size:22px;border-radius:40px;border:none;background:#0f0;color:#000;font-weight:700;cursor:pointer}
        #ui{position:absolute;bottom:40px;width:100%;display:none;justify-content:center;gap:12px;z-index:100;flex-wrap:wrap}
        button.tool-btn{padding:12px 18px;border-radius:25px;border:2px solid #0f0;background:rgba(0,0,0,0.8);color:#0f0;font-weight:700;cursor:pointer}
        button.active{background:#0f0;color:#000}
        #recBtn.recording{border-color:#ff4444;color:#ff4444;animation:blink 1s infinite}@keyframes blink{50%{opacity:.5}}
    </style>
</head>
<body>
    <div id="landing">
        <img src="logo.png" id="app-logo" alt="Logo">
        <h1>SymmetryFace</h1>
        <p>×—×•×•×™×™×ª ×¡×™××˜×¨×™×” ××œ××” ×œ×œ× ×¨×§×¢.</p>
        <button id="startBtn" onclick="startApp()">×”×ª×—×œ×ª ×—×•×•×™×”</button>
    </div>

    <video id="videoElement" playsinline autoplay muted></video>
    <canvas id="mainCanvas"></canvas>
    <canvas id="tempCanvas" style="display:none"></canvas>
    
    <div id="ui">
        <button onclick="setMode('none')" id="btnNone" class="tool-btn active">×¨×’×™×œ</button>
        <button onclick="setMode('left')" id="btnLeft" class="tool-btn">×©×××œ</button>
        <button onclick="setMode('right')" id="btnRight" class="tool-btn">×™××™×Ÿ</button>
        <button onclick="takeSnapshot()" class="tool-btn" style="border-color:#fff;color:#fff">ğŸ“¸</button>
        <button onclick="toggleRecording()" id="recBtn" class="tool-btn" style="border-color:#ff4444;color:#ff4444">âº</button>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const tempCanvas = document.getElementById('tempCanvas');
        const tCtx = tempCanvas.getContext('2d');

        let currentMode = 'none', smoothNoseX = 0, selfieSegmentation;

        async function startApp() {
            document.getElementById('landing').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('ui').style.display = 'flex';
            await initModels();
        }

        async function initModels() {
            // ×˜×¢×™× ×ª ××•×“×œ ×–×™×”×•×™ ×¤× ×™×
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');

            // ×˜×¢×™× ×ª ××•×“×œ ×”×¡×¨×ª ×¨×§×¢
            selfieSegmentation = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
            selfieSegmentation.setOptions({ modelSelection: 1 }); // 1 ×œ××•×“×œ ××“×•×™×§ ×™×•×ª×¨
            selfieSegmentation.onResults(onResults);

            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = tempCanvas.width = video.videoWidth;
                canvas.height = tempCanvas.height = video.videoHeight;
                smoothNoseX = canvas.width / 2;
                sendToSegmentation();
            };
        }

        async function sendToSegmentation() {
            if (!video.paused && !video.ended) {
                await selfieSegmentation.send({image: video});
            }
            requestAnimationFrame(sendToSegmentation);
        }

        async function onResults(results) {
            // 1. ×¦×™×•×¨ ×”××¡×›×” ×¢×œ ×”×§× ×‘×¡ ×”×–×× ×™
            tCtx.save();
            tCtx.clearRect(0, 0, canvas.width, canvas.height);
            tCtx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            
            // 2. ×—×™×ª×•×š ×”×“××•×ª ××ª×•×š ×”×•×™×“××• ×”××§×•×¨×™
            tCtx.globalUint8ClampedArray = 'source-in'; // ××¦×™×’ ×¨×§ ××™×¤×” ×©×™×© ××¡×›×”
            tCtx.globalCompositeOperation = 'source-in';
            tCtx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            tCtx.restore();

            // 3. ×—×™×©×•×‘ ×¡×™××˜×¨×™×” (×©×™××•×© ×‘-FaceAPI ×œ×–×™×”×•×™ ××™×§×•× ×”××£)
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            if (detections.length > 0) {
                const noseX = detections[0].landmarks.getNose()[0].x;
                smoothNoseX += (noseX - smoothNoseX) * 0.15;
            }

            // 4. ×¦×™×•×¨ ×”×ª×•×¦××” ×”×¡×•×¤×™×ª ×¢×œ ×”×§× ×‘×¡ ×”×¨××©×™
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const w = canvas.width, h = canvas.height;

            if (currentMode === 'none') {
                ctx.drawImage(tempCanvas, 0, 0);
            } else if (currentMode === 'left') {
                drawSymmetry(0, smoothNoseX);
            } else if (currentMode === 'right') {
                drawSymmetry(smoothNoseX, w - smoothNoseX);
            }
        }

        function drawSymmetry(sourceX, width) {
            ctx.drawImage(tempCanvas, sourceX, 0, width, canvas.height, sourceX, 0, width, canvas.height);
            ctx.save();
            ctx.translate(smoothNoseX * 2, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(tempCanvas, sourceX, 0, width, canvas.height, sourceX, 0, width, canvas.height);
            ctx.restore();
        }

        function setMode(m) {
            currentMode = m;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + m.charAt(0).toUpperCase() + m.slice(1)).classList.add('active');
        }

        // ×¦×™×œ×•× ×•×”×§×œ×˜×” × ×©××¨×™× ××•×ª×• ×“×‘×¨...
        function takeSnapshot() {
            const l = document.createElement('a');
            l.download = 'Symmetry-NoBackground.png';
            l.href = canvas.toDataURL('image/png');
            l.click();
        }
    </script>
</body>
</html>
